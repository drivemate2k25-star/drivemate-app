<!-- ride_detail.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  {% load address_filters %}
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ride #{{ ride.pk }} â€” DriveMate</title>

  <script src="/static/tailwind.js"></script>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <style>
    :root{ --primary:#3d99f5; --muted:#6b7280; --bg:#f8fafc; }
    body{ font-family:'Space Grotesk', sans-serif; background:var(--bg); color:#0f172a; }
    .material-symbols-outlined{ font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24; }
    .kbd { background:#111827; color:white; padding:.15rem .5rem; border-radius:.35rem; font-size:.8rem; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
      /* cursor for desktop dragging */
      .draggable { cursor: grab; }
      .draggable.dragging { cursor: grabbing; user-select: none; }
    </style>
    

</head>
<body class="antialiased">

  <!-- Header -->
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="material-symbols-outlined text-3xl" style="color:var(--primary)">directions_car</span>
        <h1 class="text-2xl font-bold tracking-tight">DriveMate</h1>
      </div>
      <div>
        <a href="{% url 'my_trips' %}" class="inline-flex items-center gap-2 px-3 py-2 rounded hover:bg-gray-50">
          <span class="material-symbols-outlined">arrow_back</span> Back
        </a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-6 py-8 mb-20 ">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left: Ride summary -->
      <div class="lg:col-span-2 space-y-4">
        <div class="bg-white rounded-2xl shadow p-6">
          <div class="flex items-start justify-between">
            <div>
              <h2 class="text-2xl font-bold">Ride #{{ ride.pk }}</h2>
              <p class="text-sm text-gray-500 mt-1">Requested: {{ ride.created_at|date:"Y-m-d H:i" }}</p>
            </div>
            <div class="text-right">
              <div class="text-sm text-gray-600">{{ ride.get_ride_mode_display }}</div>
              <div class="mt-2">
                <span class="inline-block text-sm px-3 py-1 rounded-full
                  {% if ride.status == 'requested' %} bg-blue-50 text-blue-700
                  {% elif ride.status == 'ongoing' %} bg-amber-50 text-amber-700
                  {% elif ride.status == 'completed' %} bg-emerald-50 text-emerald-700
                  {% elif ride.status == 'cancelled' %} bg-red-50 text-red-700
                  {% else %} bg-gray-50 text-gray-700{% endif %}">{{ ride.get_status_display }}</span>
              </div>
            </div>
          </div>

          <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
            <div>
              <p><strong>From:</strong> {{ ride.start_location|before_comma }}</p>
              <p class="text-sm text-gray-400">Coordinates: ({{ ride.start_latitude }}, {{ ride.start_longitude }})</p>
            </div>
            <div>
              <p><strong>To:</strong> {{ ride.end_location|before_comma }}</p>
            </div>
          </div>

          {% if ride.total_amount is not None and ride.get_status_display != 'Completed' %}
            <div class="mt-6">
              <a href="{% url 'ride_payment' ride.pk %}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-[var(--primary)] text-white hover:bg-blue-600">
                <span class="material-symbols-outlined">payment</span> Pay Now ({{ ride.total_amount }})
              </a>
            </div>
          {% endif %}
        </div>

        <!-- Driver requests list -->
        <div class="bg-white rounded-2xl shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Driver requests</h3>
            <span class="text-sm text-gray-500">{{ driver_requests|length }} requests</span>
          </div>

          <div class="space-y-3">
            {% for rr in driver_requests %}
              <div class="border rounded-lg p-4 flex items-center justify-between hover:shadow-sm transition">
                <div>
                  <div class="font-medium">{{ rr.driver.user.name }}</div>
                  <div class="text-sm text-gray-500 mt-1">{{ rr.requested_at|date:"Y-m-d H:i" }}</div>
                </div>

                <div class="flex items-center gap-3">
                  <div class="text-sm text-gray-600">{{ rr.get_status_display }}</div>

                  {% if rr.status == rr.Status.PENDING %}
                    <form method="post" style="display:inline">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="close_request">
                      <input type="hidden" name="request_id" value="{{ rr.id }}">
                      <button class="px-3 py-2 rounded-lg border border-red-200 text-sm text-red-700 hover:bg-red-50" type="submit">Close</button>
                    </form>
                  {% endif %}
                </div>
              </div>
            {% empty %}
              <div class="text-gray-500">No driver requests yet.</div>
            {% endfor %}
          </div>
        </div>

        <!-- Payment success block (preserve behavior) -->
        {% if payment.status == 'success' %}
          <div class="bg-white rounded-2xl shadow p-6">
            <h3 class="text-lg font-semibold mb-3">Payment Completed</h3>
            <div class="text-gray-700 space-y-2">
              <p><strong>Amount:</strong> {{ payment.amount }} {{ payment.currency }}</p>
              <p><strong>Payment Method:</strong> {{ payment.method|title }}</p>
              <p><strong>Transaction ID:</strong> {{ payment.transaction_id|default:"Not available" }}</p>
              <p><strong>Paid On:</strong> {{ payment.paid_at|date:"F d, Y H:i" }}</p>
              {% if payment.tip_amount > 0 %}
                <p><strong>Tip Amount:</strong> {{ payment.tip_amount }} {{ payment.currency }}</p>
              {% endif %}
              {% if payment.discount_amount > 0 %}
                <p><strong>Discount Applied:</strong> {{ payment.discount_amount }} {{ payment.currency }}</p>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </div>

      <!-- Right: Assigned driver & actions -->
      <aside class="space-y-4">
        {% if ride.driver %}
          <div class="bg-white rounded-2xl shadow p-6">
            <h3 class="text-lg font-semibold">Assigned driver</h3>
            <div class="mt-4 flex items-center gap-4">
              <div class="w-20 h-20 rounded-lg bg-gray-100 overflow-hidden">
                {% if ride.driver.profile_pic %}
                  <img src="{{ ride.driver.profile_pic.url }}" alt="{{ ride.driver.user.name }}" class="w-full h-full object-cover">
                {% else %}
                  <img src="https://images.unsplash.com/photo-1542362567-b07e54358753?auto=format&fit=crop&w=400&q=60" alt="driver" class="w-full h-full object-cover">
                {% endif %}
              </div>
              <div class="flex-1">
                <div class="font-semibold">{{ ride.driver.user.name }}</div>
                <div class="text-sm text-gray-500">Rating: {{ ride.driver.rating }}</div>
                <div class="text-sm text-gray-500 mt-1">Mob: {{ ride.driver.user.phone }}</div>
                <div class="mt-3 flex gap-2">
                  <a href="tel:{{ ride.driver.user.phone }}"  class="px-3 py-2 rounded-lg border border-gray-200 text-sm hover:bg-gray-100"><span class="material-symbols-outlined " style="font-size: 17px;">phone</span></a>
                  <!-- WhatsApp -->
                  <a href="https://wa.me/{{ ride.driver.user.phone }}" target="_blank" class="px-3 py-2 rounded-lg border border-gray-200 text-sm hover:bg-green-50 flex items-center gap-1 text-green-600"> <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/whatsapp.svg" alt="WhatsApp" class="w-4 h-4"></a>
                  <a class="px-3 py-2 rounded-lg border border-gray-200 text-sm" href="{% url 'rate_ride' ride.id %}">Rate </a>
                  <a class="px-3 py-2 rounded-lg border border-gray-200 text-sm" href="{% url 'view_driver_rating' ride.driver.id %}">@</a>
                  {% if ride.status == 'requested' %}
                  <a href="{% url 'select_driver' ride.id %}" class="px-3 py-2 rounded-lg bg-blue-50 text-blue-700 border border-blue-100 text-sm">Find another</a>
                  {% endif %}
                </div>
              </div>
            </div>
            {% if messages %}
            {% for m in messages %}
              <div class="msg">{{ m }}</div>
            {% endfor %}
          {% endif %}
          </div>
        {% endif %}


        {% if ride.vehicle %}
        <div class="bg-white rounded-2xl shadow p-6">
          <h3 class="text-lg font-semibold">Assigned Car</h3>

          <div class="mt-4 flex items-start gap-4">

            {% if ride.vehicle.images.count %}
              <div class="relative group">
                <!-- prev button -->
                <button type="button"
                        onclick="changeSlide('{{ ride.id }}', -1)"
                        class="absolute left-2 top-1/2 -translate-y-1/2 z-10 bg-black/40 text-white rounded-full p-2 shadow hidden group-hover:flex transition">
                  &#9664;
                </button>

                <!-- gallery: allow horizontal scroll, hide native scrollbar but allow programmatic & touch scroll -->
                <div id="gallery-{{ ride.id }}"
                  data-autoplay="true"
                  data-interval="3000"
                  class="flex overflow-x-auto snap-x snap-mandatory w-full rounded-xl scroll-smooth no-scrollbar touch-pan-x"
                  style="-webkit-overflow-scrolling: touch;">
                  {% for img in ride.vehicle.images.all %}
                    <div class="snap-center flex-shrink-0 w-[85%] sm:w-[70%] md:min-w-full h-40 md:h-56 relative mx-auto">
                      <img src="{{ img.image.url }}"
                          alt="{{ img.caption|default:ride.vehicle.model }}"
                          title="{{ img.caption|default:ride.vehicle.model }}"
                          class="w-full h-full object-cover rounded-xl">
                    </div>
                  {% endfor %}
                </div>


                <!-- next button -->
                <button type="button"
                        onclick="changeSlide('{{ ride.id }}', 1)"
                        class="absolute right-2 top-1/2 -translate-y-1/2 z-10 bg-black/40 text-white rounded-full p-2 shadow hidden group-hover:flex transition">
                  &#9654;
                </button>

                <!-- dot indicators (clickable) -->
                <div class="mt-2 flex justify-center gap-2">
                  {% for img in ride.vehicle.images.all %}
                    <button type="button" onclick="goToSlide('{{ ride.id }}', {{ forloop.counter0 }})"
                            class="dot-{{ ride.id }} w-2 h-2 rounded-full bg-gray-300 transition focus:outline-none"></button>
                  {% endfor %}
                </div>
              </div>
            {% else %}
              <!-- fallback -->
              <div class="w-full h-56 rounded-xl overflow-hidden border">
                <img src="https://images.unsplash.com/photo-1542362567-b07e54358753?auto=format&fit=crop&w=1200&q=60"
                    alt="vehicle" class="w-full h-full object-cover">
              </div>
            {% endif %}

          </div>
        </div>
        {% endif %}


        <!-- Primary action: reopen -->
        <div class="bg-white rounded-2xl shadow p-6">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="reopen_ride">
            {% if ride.get_status_display == "requested" %}
              <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-[var(--primary)] text-white hover:bg-blue-600">
                <span class="material-symbols-outlined">search</span> Find another driver
              </button>
            {% endif %}
          </form>

          <a class="block mt-3 text-center text-sm text-gray-600" href="{% url 'my_trips' %}">Back to trips</a>
        </div>
      </aside>
    </div>
  </main>

  <footer class="w-full fixed bottom-0 bg-white border-t border-gray-200">
    <div class="container mx-auto">
      <nav class="flex justify-around">
        <a class="flex flex-col items-center justify-center gap-1 py-3 text-[var(--muted)] hover:text-[var(--primary-color)] flex-1" href="{% url 'customer_dashboard'%}">
          <span class="material-symbols-outlined">home</span>
          <span class="text-xs font-bold">Home</span>
        </a>
        <a class="flex flex-col items-center justify-center gap-1 py-3 text-[var(--primary-color)] border-t-2 border-[var(--primary-color)]  flex-1" href="{% url 'my_trips'%}">
          <span class="material-symbols-outlined">local_taxi</span>
          <span class="text-xs font-bold">Ride</span>
        </a>
        <a class="flex flex-col items-center justify-center gap-1 py-3 text-[var(--muted)] hover:text-[var(--primary-color)] flex-1" href="{% url 'customer_profile' %}">
          <span class="material-symbols-outlined">person</span>
          <span class="text-xs font-bold">Profile</span>
        </a>
        <a class="flex flex-col items-center justify-center gap-1 py-3 text-[var(--muted)] hover:text-[var(--primary-color)] flex-1" href="{% url 'customer_payment_history'%}">
          <span class="material-symbols-outlined">payment</span>
          <span class="text-xs font-bold">Payments</span>
        </a>
        <a class="flex flex-col items-center justify-center gap-1 py-3 text-[var(--muted)] hover:text-[var(--primary-color)] flex-1" href="#">
          <span class="material-symbols-outlined">support_agent</span>
          <span class="text-xs font-bold">Support</span>
        </a>
      </nav>
    </div>
  </footer>

  <script>
    (function(){
      const galleries = {}; // store state per gallery id
    
      function initGallery(gallery) {
        const id = gallery.id.split('-')[1];
        const slidesCount = gallery.children.length;
        if (!id || slidesCount <= 0) return;
    
        const autoplayEnabled = gallery.dataset.autoplay === 'true';
        const intervalMs = parseInt(gallery.dataset.interval || '3000', 10);
    
        // state
        galleries[id] = {
          el: gallery,
          slides: slidesCount,
          index: 0,
          autoplayEnabled,
          intervalMs,
          autoplayTimer: null,
          idleTimer: null,
          userInteracted: false,
          isDragging: false,
          dragStartX: 0,
          dragStartScroll: 0
        };
    
        const state = galleries[id];
        gallery.classList.add('draggable');
    
        // sync initial dots
        updateDots(id);
    
        // scroll listener to update index & dots when user swipes
        let ticking = false;
        gallery.addEventListener('scroll', () => {
          if (ticking) return;
          ticking = true;
          requestAnimationFrame(() => {
            const newIndex = Math.round(gallery.scrollLeft / gallery.offsetWidth);
            if (newIndex !== state.index) {
              state.index = newIndex;
              updateDots(id);
            }
            ticking = false;
          });
        }, { passive: true });
    
        // pointer events: only implement custom drag for mouse/pen (desktop).
        gallery.addEventListener('pointerdown', (e) => {
          // if touch, do not hijack (let native swipe handle)
          if (e.pointerType === 'touch') {
            pauseAutoplay(id); // still pause autoplay on touch
            return;
          }
          // mouse/pen -> implement drag
          state.isDragging = true;
          state.dragStartX = e.clientX;
          state.dragStartScroll = gallery.scrollLeft;
          gallery.setPointerCapture(e.pointerId);
          gallery.classList.add('dragging');
          pauseAutoplay(id);
        });
    
        gallery.addEventListener('pointermove', (e) => {
          if (!state.isDragging) return;
          const dx = e.clientX - state.dragStartX;
          gallery.scrollLeft = state.dragStartScroll - dx;
        });
    
        const endDrag = (e) => {
          if (!state.isDragging) return;
          state.isDragging = false;
          gallery.classList.remove('dragging');
          // snap to nearest slide
          const idx = Math.round(gallery.scrollLeft / gallery.offsetWidth);
          state.index = Math.max(0, Math.min(state.slides - 1, idx));
          gallery.scrollTo({ left: gallery.offsetWidth * state.index, behavior: 'smooth' });
          resumeAutoplayWithDelay(id);
        };
    
        gallery.addEventListener('pointerup', endDrag);
        gallery.addEventListener('pointercancel', endDrag);
        gallery.addEventListener('mouseleave', (e) => {
          // if pointer leaves while dragging with mouse, also end drag
          if (state.isDragging && e.relatedTarget === null) endDrag(e);
        });
    
        // pause on hover for desktop
        gallery.addEventListener('mouseenter', () => pauseAutoplay(id));
        gallery.addEventListener('mouseleave', () => resumeAutoplayWithDelay(id));
    
        // pause on touchstart (mobile) and resume after delay
        gallery.addEventListener('touchstart', () => pauseAutoplay(id), { passive: true });
        gallery.addEventListener('touchend', () => resumeAutoplayWithDelay(id), { passive: true });
    
        // clickable dots: already implemented as buttons that call goToSlide()
        // visibility change: pause when tab hidden
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) pauseAutoplay(id);
          else resumeAutoplayWithDelay(id);
        });
    
        // start autoplay if enabled
        if (autoplayEnabled && slidesCount > 1) startAutoplay(id);
        // keep correct position on resize
        window.addEventListener('resize', () => {
          gallery.scrollTo({ left: gallery.offsetWidth * state.index, behavior: 'auto' });
        });
      }
    
      // change slide (for prev/next buttons)
      function changeSlide(rideId, direction) {
        const s = galleries[rideId];
        if (!s) return;
        s.index = (s.index + direction + s.slides) % s.slides;
        s.el.scrollTo({ left: s.el.offsetWidth * s.index, behavior: 'smooth' });
        updateDots(rideId);
        resetAutoplayDueToUser(rideId);
      }
    
      // go to specific slide (dots)
      function goToSlide(rideId, index) {
        const s = galleries[rideId];
        if (!s) return;
        s.index = Math.max(0, Math.min(s.slides - 1, index));
        s.el.scrollTo({ left: s.el.offsetWidth * s.index, behavior: 'smooth' });
        updateDots(rideId);
        resetAutoplayDueToUser(rideId);
      }
    
      // update dots visuals
      function updateDots(rideId) {
        const s = galleries[rideId];
        if (!s) return;
        const dots = document.querySelectorAll(`.dot-${rideId}`);
        dots.forEach((dot, i) => {
          dot.classList.toggle('bg-gray-800', i === s.index);
          dot.classList.toggle('bg-gray-300', i !== s.index);
        });
      }
    
      // autoplay helpers
      function startAutoplay(rideId) {
        const s = galleries[rideId];
        if (!s || !s.autoplayEnabled) return;
        if (s.autoplayTimer) clearInterval(s.autoplayTimer);
        s.autoplayTimer = setInterval(() => {
          // advance by 1
          s.index = (s.index + 1) % s.slides;
          s.el.scrollTo({ left: s.el.offsetWidth * s.index, behavior: 'smooth' });
          updateDots(rideId);
        }, s.intervalMs);
      }
    
      function stopAutoplay(rideId) {
        const s = galleries[rideId];
        if (!s) return;
        if (s.autoplayTimer) {
          clearInterval(s.autoplayTimer);
          s.autoplayTimer = null;
        }
      }
    
      function pauseAutoplay(rideId) {
        const s = galleries[rideId];
        if (!s) return;
        s.userInteracted = true;
        stopAutoplay(rideId);
        // clear pending resume timer
        if (s.idleTimer) { clearTimeout(s.idleTimer); s.idleTimer = null; }
      }
    
      function resumeAutoplayWithDelay(rideId, delay = 3000) {
        const s = galleries[rideId];
        if (!s) return;
        // after user stops interacting, wait `delay` ms then resume
        if (s.idleTimer) clearTimeout(s.idleTimer);
        s.idleTimer = setTimeout(() => {
          s.userInteracted = false;
          startAutoplay(rideId);
          s.idleTimer = null;
        }, delay);
      }
    
      function resetAutoplayDueToUser(rideId) {
        pauseAutoplay(rideId);
        resumeAutoplayWithDelay(rideId, 3000);
      }
    
      // expose functions to global so buttons/dot onclick can call
      window.changeSlide = changeSlide;
      window.goToSlide = goToSlide;
    
      // init all galleries once dom ready
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('[id^="gallery-"]').forEach(gallery => initGallery(gallery));
      });
    
      // Also expose an init function in case you dynamically inject galleries later
      window.__DriveMateGallery = { initGallery };
    
    })();
    </script>
    
  
</body>
</html>
