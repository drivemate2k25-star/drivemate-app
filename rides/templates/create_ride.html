<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DriveMate - Create Ride</title>

  <!-- Tailwind (keeps same local setup as your home page) -->
  <script src="/static/js/tailwind.js"></script>
  <style>
    .leaflet-control-attribution.leaflet-control {
        display: none;
    }
  </style>

  <!-- Google fonts & Material Symbols (same as home) -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Leaflet -->
  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet/dist/leaflet.css"
/>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet/dist/leaflet.js"
></script>

  <style type="text/tailwindcss">
    :root {
      --primary-color: #000000;
      --background-color: #f9f9f9;
      --text-primary: #333333;
      --text-secondary: #666666;
      --accent-color: #e0f2f7;
    }
    body { font-family: 'Space Grotesk', sans-serif; }
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    /* small helpers */
    .size-2 { width: .5rem; height: .5rem; }
    .size-10 { width: 2.5rem; height: 2.5rem; }
    .size-16 { width: 4rem; height: 4rem; }
  </style>
</head>

<body class="bg-[var(--background-color)] text-[var(--text-primary)]">
  <div class="relative flex size-full min-h-screen flex-col group/design-root overflow-x-hidden">
    <div class="layout-container flex h-full grow flex-col">

      <!-- header (copied from home) -->
      <header class="bg-white shadow-sm">
        <div class="container mx-auto flex items-center justify-between whitespace-nowrap px-6 py-4">
          <div class="flex items-center gap-3 text-[var(--text-primary)]">
            <span class="material-symbols-outlined text-3xl text-[var(--primary-color)]">directions_car</span>
            <h1 class="text-2xl font-bold tracking-tight">DriveMate</h1>
          </div>

          <div class="flex items-center gap-4">
            <button class="relative flex cursor-pointer items-center justify-center rounded-full size-10 hover:bg-gray-100">
              <span class="material-symbols-outlined text-[var(--text-secondary)]">notifications</span>
              <div class="absolute top-1 right-1 size-2 rounded-full bg-red-500 border-2 border-white"></div>
            </button>

            <a href="{% url 'logout' %}">
              <button class="relative flex cursor-pointer items-center justify-center rounded-full size-10 hover:bg-gray-100">
                <span class="material-symbols-outlined text-[var(--text-secondary)]">logout</span>
              </button>
            </a>

            <a  href="{% url 'customer_profile' %}"><div class="size-10 rounded-full bg-cover bg-center" style='background-image: url("https://static.vecteezy.com/system/resources/thumbnails/004/511/281/small_2x/default-avatar-photo-placeholder-profile-picture-vector.jpg");'></div></a>
          </div>
        </div>
      </header>

      <!-- main content -->
      <main class="container mx-auto flex-1 px-6 py-8 mb-[60px]">
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-8">
          <div class="flex items-center justify-between">
            <h2 class="text-3xl font-bold mb-2">Create a New Ride</h2>
            <a class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-[var(--primary-color)] text-[var(--primary-color)] hover:bg-[var(--accent-color)]" href="#">
              <span class="material-symbols-outlined">arrow_back</span> Back to Home
            </a>
          </div>

          <!-- quick search mini form (optional, unobtrusive) -->
          <form method="GET" action="{% url 'create_ride' %}" class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
            <div class="col-span-2">
              <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1" for="quick_location">Quick Location</label>
              <div class="relative">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-secondary)]">search</span>
                <input id="quick_location" name="q" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]" placeholder="Enter a location to prefill the map" type="text"/>
              </div>
            </div>
            <div>
              <button type="submit" class="w-full bg-[var(--primary-color)] text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-colors">Prefill</button>
            </div>
          </form>
        </div>

        <!-- actual form area (keeps all backend field names & ids intact) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <form method="POST" class="col-span-1 lg:col-span-2 bg-white p-6 rounded-2xl shadow-md">
            {% csrf_token %}

            <!-- Django messages (cleaned rendering so classes work as expected) -->
            {% if messages %}
              <div class="mb-4 space-y-2">
                {% for message in messages %}
                  {% if message.tags == 'error' %}
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" role="alert">
                      {{ message }}
                    </div>
                  {% else %}
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded" role="alert">
                      {{ message }}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}

            <div class="mb-4">
              <label class="block text-gray-700 font-medium mb-1">Ride Mode</label>
              <select name="ride_mode" class="w-full p-3 border rounded-lg">
                {% for mode, display in ride_modes %}
                  <option value="{{ mode }}" {% if mode == default_mode %}selected{% endif %}>{{ display }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-4">
              <label class="block text-gray-700 font-medium mb-1">Purpose</label>
              <select name="purpose" class="w-full p-3 border rounded-lg">
                <option value="">Select Purpose (Optional)</option>
                {% for purpose in purposes %}
                  <option value="{{ purpose.id }}">{{ purpose.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-4">
              <div class="flex justify-between items-center">
                <label class="block text-gray-700 font-medium mb-1">Start Location</label>
                <button type="button" id="use-current-location" class="text-sm bg-[var(--primary-color)] text-white py-2 px-3 rounded hover:bg-blue-600">Use My Location</button>
              </div>
              <input type="text" id="start_location" name="start_location" class="w-full p-3 border rounded-lg mt-1" readonly>
              <input type="hidden" id="start_latitude" name="start_latitude">
              <input type="hidden" id="start_longitude" name="start_longitude">
            </div>

            <div class="mb-4">
              <label class="block text-gray-700 font-medium mb-1">End Location</label>
              <input type="text" id="end_location" name="end_location" class="w-full p-3 border rounded-lg mt-1" readonly>
              <input type="hidden" id="end_latitude" name="end_latitude">
              <input type="hidden" id="end_longitude" name="end_longitude">
            </div>

            <div class="mb-4">
              <label class="block text-gray-700 font-medium mb-1">Notes</label>
              <textarea id="notes" name="notes" class="w-full p-3 border rounded-lg" rows="3"></textarea>
            </div>

            <div class="mb-4 flex items-center gap-3">
              <input type="checkbox" id="female_driver" name="female_driver" value="true" class="h-4 w-4 rounded border-gray-300">
              <label for="female_driver" class="text-gray-700">Prefer Female Driver</label>
            </div>

            <div class="mb-4">
              <p id="map-instruction" class="text-gray-600 mb-2 font-medium">Click on the map to set your starting point.</p>
              <div id="map" style="height: 420px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06);"></div>
            </div>

            <button type="submit" class="bg-[var(--primary-color)] text-white p-3 rounded-lg hover:bg-blue-600 w-full font-semibold">Create Ride</button>
          </form>

          <!-- right column: context, recent destinations, tips -->
          <aside class="col-span-1">
            <!-- <div class="bg-white rounded-2xl shadow-md p-6 mb-6">
              <h3 class="text-lg font-bold mb-2">Recent Destinations</h3>
              <div class="grid grid-cols-1 gap-3">
                <div class="flex items-center gap-3">
                  <div class="size-16 bg-cover bg-center rounded-lg" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuANIpRtmYvjG3M4NpEDL4fkpIq7cqtwo7GdH0mFyQKH5R_Z2f7KtlPfVRwpmZtYSWkKDTbf_zLdfhA7deY5b6HPz5NMF9kMDlyM2nbVUS4-03UFJZTlXXBMGYfCcRslA8I7dQ1XKeZgt0BzXU5yvwnOGxDSQvDdhyrSIPOor9-upGVHHQh_SMy2d4Q2mhRDq-PpEBVluaiLkwHUEjLfCKpu9FCy8y0rQztd8ipBVYPPaYeQx3XOHrggvejgnr4sKLMdcRmXFiwu_g");'></div>
                  <div>
                    <p class="font-semibold">Downtown</p>
                    <p class="text-sm text-[var(--text-secondary)]">Frequent pickup</p>
                  </div>
                </div>

                <div class="flex items-center gap-3">
                  <div class="size-16 bg-cover bg-center rounded-lg" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCIdUivvfmvj3eSjD_eE543ohKmVI_nx8lRkZP95imrO6hsSINrKjQNECTqoZrh9h8JHS6YSrqOqSzwov_Pa-DYFCLLSFtuhnEyL8Py5bymbHqFY1od4RTuCRZ9CDUYnU4icvZagWO3GFoQv1MRikOoBtiUZq5ZLp-JWl_2xRZiIaGum3ndmM6N8bxxZr29IradTjMgNAyr4tk5ycHrPHqubyeiNygiXT1O8H5S7qVCau1qgW6d7TJIt6n1mL4R3FVacwfP88n_3A");'></div>
                  <div>
                    <p class="font-semibold">Airport</p>
                    <p class="text-sm text-[var(--text-secondary)]">Recommended for early trips</p>
                  </div>
                </div>

                <a href="{% url 'my_trips' %}" class="inline-block mt-3 text-sm text-[var(--primary-color)]">View all destinations →</a>
              </div>
            </div> -->

            <div class="bg-white rounded-2xl shadow-md p-6">
              <h3 class="text-lg font-bold mb-2">Map Tips</h3>
              <ul class="text-sm text-[var(--text-secondary)] space-y-2">
                <li>• Click map to set start & destination (click alternates).</li>
                <li>• Drag markers to fine tune the location.</li>
                <li>• Use "Use My Location" for quick pickup.</li>
                <li>• Addresses are reverse-geocoded and filled into the form.</li>
              </ul>
            </div>
          </aside>
        </div>
      </main>

      <!-- footer (same style as home) -->
      <footer class=" w-full fixed flex bottom-0 bg-white border-t border-gray-200">
        <div class="container mx-auto">
          <nav class="flex justify-around">
            <a class="flex flex-col items-center justify-center gap-1 py-3 text-[var(--text-secondary)] hover:text-[var(--primary-color)] flex-1" href="{% url 'customer_dashboard'  %}">
              <span class="material-symbols-outlined">home</span>
              <span class="text-xs font-bold">Home</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 py-3 text-[var(--primary-color)] border-t-2 border-[var(--primary-color)] flex-1" href="{% url 'my_trips' %}">
              <span class="material-symbols-outlined">trip</span>
              <span class="text-xs font-bold">Trip</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 py-3 text-[var(--text-secondary)] hover:text-[var(--primary-color)] flex-1" href="{% url 'customer_profile' %}">
              <span class="material-symbols-outlined">person</span>
              <span class="text-xs font-bold">Profile</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 py-3 text-[var(--text-secondary)] hover:text-[var(--primary-color)] flex-1" href="#">
              <span class="material-symbols-outlined">payment</span>
              <span class="text-xs font-bold">Payments</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 py-3 text-[var(--text-secondary)] hover:text-[var(--primary-color)] flex-1" href="#">
              <span class="material-symbols-outlined">support_agent</span>
              <span class="text-xs font-bold">Support</span>
            </a>
          </nav>
        </div>
      </footer>

    </div>
  </div>

  <!-- Map & UI JavaScript: uses exactly the same logic you already had (IDs/names kept identical) -->
  <script>
    // wait until Leaflet has loaded (defer script included above)
    (function () {
      // Initialize Leaflet map with a default view
      const map = L.map('map').setView([11.2588, 75.7804], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // State variables
      let startMarker, endMarker;
      let isSettingStart = true; // toggles between start and end
      const instructionEl = document.getElementById('map-instruction');

      // Reverse geocoding function (Nominatim)
      async function reverseGeocode(lat, lon) {
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
          const data = await response.json();
          return data.display_name || 'Unknown location';
        } catch (error) {
          console.error("Reverse geocoding failed:", error);
          return "Could not fetch address";
        }
      }

      // Update fields and marker popup
      async function updateLocationFields(marker, latField, lonField, locField, pointType) {
        const latlng = marker.getLatLng();
        document.getElementById(latField).value = latlng.lat.toFixed(6);
        document.getElementById(lonField).value = latlng.lng.toFixed(6);

        const address = await reverseGeocode(latlng.lat, latlng.lng);
        document.getElementById(locField).value = address;
        marker.bindPopup(`<b>${pointType} Location</b><br>${address}`).openPopup();
      }

      async function placeMarker(latlng) {
        if (isSettingStart) {
          if (!startMarker) {
            startMarker = L.marker(latlng, { draggable: true }).addTo(map);
            startMarker.on('dragend', () => updateLocationFields(startMarker, 'start_latitude', 'start_longitude', 'start_location', 'Start'));
          } else {
            startMarker.setLatLng(latlng);
          }
          await updateLocationFields(startMarker, 'start_latitude', 'start_longitude', 'start_location', 'Start');
          instructionEl.textContent = 'Click on the map to set your destination.';
          isSettingStart = false;
        } else {
          if (!endMarker) {
            endMarker = L.marker(latlng, { draggable: true }).addTo(map);
            endMarker.on('dragend', () => updateLocationFields(endMarker, 'end_latitude', 'end_longitude', 'end_location', 'End'));
          } else {
            endMarker.setLatLng(latlng);
          }
          await updateLocationFields(endMarker, 'end_latitude', 'end_longitude', 'end_location', 'End');
          instructionEl.textContent = 'Click to adjust start point, or drag markers.';
          isSettingStart = true;
        }
      }

      // click handler
      map.on('click', (e) => placeMarker(e.latlng));

      // Use my location button
      document.getElementById('use-current-location').addEventListener('click', () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              const latlng = [position.coords.latitude, position.coords.longitude];
              map.setView(latlng, 15);
              isSettingStart = true;
              await placeMarker(L.latLng(latlng));
            },
            (error) => {
              alert("Could not get your location. Please allow location access or set it manually.");
              console.error("Geolocation error:", error);
            }
          );
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      });

      // If you want to prefill using `?q=` param (optional)
      (function prefillFromQuery() {
        try {
          const params = new URLSearchParams(location.search);
          const q = params.get('q');
          if (q) {
            document.getElementById('start_location').value = q;
          }
        } catch (e) { /* ignore */ }
      })();

    })();
  </script>
</body>
</html>
